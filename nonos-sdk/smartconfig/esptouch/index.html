<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:image" content="../../../img/logo.png"/>

  
  <meta name="author" content="Tuan PM">
  
  <title>ESPTOUCH & AIRKISS - Internet Of Things (IoT) với ESP8266</title>
  

  <link rel="shortcut icon" href="../../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">

  <link rel="stylesheet" href="../../../css/custom.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "ESPTOUCH & AIRKISS";
    var mkdocs_page_input_path = "nonos-sdk/smartconfig/esptouch.md";
    var mkdocs_page_url = "/nonos-sdk/smartconfig/esptouch/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script>
  <script src="../../../js/theme.js"></script>
  <script src="../../../js/jquery.cookie-1.4.1.min.js"></script>
  <script src="../../../js/nav.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60470603-4', 'esp8266.vn');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Internet Of Things (IoT) với ESP8266</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../.." id="Trang chủ" style="font-size:95%;font-weight:bold;">Trang chủ</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="current">
        <a class="current"  id="Nội dung" style="font-size:95%;font-weight:bold;">Nội dung</a>
    </li>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="Kiến thức cơ bản" onclick="showChildren('Kiến thức cơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> Kiến thức cơ bản</a>
        </li>
        
        <div style="display:none" id="hidden_Kiến thức cơ bản">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/introduction/" id="Tổng quan">  Tổng quan </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnTổng quan">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/about-iot/" id="Internet Of Things (IoT)">  Internet Of Things (IoT) </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnInternet Of Things (IoT)">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/about-esp8266/" id="ESP8266 & ESP8285">  ESP8266 & ESP8285 </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnESP8266 & ESP8285">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/esp-module/" id="Các loại Module">  Các loại Module </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnCác loại Module">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/board/" id="Board phát triển">  Board phát triển </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnBoard phát triển">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../introduction/prepare/" id="Phần cứng & công cụ">  Phần cứng & công cụ </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_Kiến thức cơ bảnPhần cứng & công cụ">
            
            </div>
        
        </div>
    
        <li class="current">
            <a style="padding-left:50px;" class="current"  id="ESP8266 NONOS-SDK" onclick="showChildren('ESP8266 NONOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 NONOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 NONOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../nonos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 NONOS-SDKCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/basic/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/compile-first-time/" id="Biên dịch dự án mẫu">Biên dịch dự án mẫu </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/blink-led/" id="Bật tắt LED">Bật tắt LED </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/button/" id="Nút nhấn">Nút nhấn </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/uart/" id="UART">UART </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/complex-makefile/" id="Makefile cho dự án phức tạp">Makefile cho dự án phức tạp </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/task/" id="Task">Task </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/wifi/" id="Wifi">Wifi </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/espconn/" id="ESPCONN">ESPCONN </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/mdns/" id="MDNS">MDNS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/ntp/" id="NTP">NTP </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../basic/save-to-flash/" id="Lưu dữ liệu vào Flash">Lưu dữ liệu vào Flash </a>
                </li>
            
            </div>
        
            <li class="current">
                <a style="padding-left:70px;" class="current"  id="Smartconfig" onclick="showChildren('ESP8266 NONOS-SDKSmartconfig')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Smartconfig </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKSmartconfig">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../smartconfig/" id="ESP8266 Smartconfig">ESP8266 Smartconfig </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../why-smartconfig/" id="Tại sao cần Smartconfig">Tại sao cần Smartconfig </a>
                </li>
            
                <li class="current">
                    <a style="padding-left:90px;" class="current" href="./" id="ESPTOUCH & AIRKISS">ESPTOUCH & AIRKISS </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../wps/" id="WPS">WPS </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="MQTT" onclick="showChildren('ESP8266 NONOS-SDKMQTT')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  MQTT </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKMQTT">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../mqtt/what-is-mqtt/" id="Giao thức MQTT">Giao thức MQTT </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../mqtt/mqtt-client/" id="ESP8266 MQTT Client">ESP8266 MQTT Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Client" onclick="showChildren('ESP8266 NONOS-SDKHTTP Client')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Client </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKHTTP Client">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../http-client/http-client/" id="ESP8266 HTTP Client">ESP8266 HTTP Client </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="HTTP Server" onclick="showChildren('ESP8266 NONOS-SDKHTTP Server')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  HTTP Server </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKHTTP Server">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../http-server/http-server/" id="ESP8266 HTTP Server">ESP8266 HTTP Server </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Firmware Over The Air" onclick="showChildren('ESP8266 NONOS-SDKFirmware Over The Air')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Firmware Over The Air </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKFirmware Over The Air">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../fota/fota/" id="FOTA">FOTA </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Now" onclick="showChildren('ESP8266 NONOS-SDKESP Now')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Now </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKESP Now">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../esp-now/esp-now/" id="ESP Now">ESP Now </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="ESP Mesh" onclick="showChildren('ESP8266 NONOS-SDKESP Mesh')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  ESP Mesh </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKESP Mesh">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../esp-mesh/esp-mesh/" id="ESP Mesh">ESP Mesh </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Các dự án" onclick="showChildren('ESP8266 NONOS-SDKCác dự án')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Các dự án </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 NONOS-SDKCác dự án">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../projects/list/" id="Danh sách">Danh sách </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 FreeRTOS-SDK" onclick="showChildren('ESP8266 FreeRTOS-SDK')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 FreeRTOS-SDK</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDK">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../freertos-sdk/freertos-sdk/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 FreeRTOS-SDKCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 FreeRTOS-SDKCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../freertos-sdk/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../freertos-sdk/basic/basic-task/" id="Task cơ bản">Task cơ bản </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../freertos-sdk/basic/software-timer/" id="Software Timer">Software Timer </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../freertos-sdk/basic/queue-semaphore-mutex/" id="Đồng bộ / trao đổi dữ liệu">Đồng bộ / trao đổi dữ liệu </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../freertos-sdk/basic/task-notification/" id="Task notification">Task notification </a>
                </li>
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 Arduino" onclick="showChildren('ESP8266 Arduino')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Arduino</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Arduino">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../arduino/arduino/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 ArduinoGiới thiệu">
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="ESP8266 Micropython" onclick="showChildren('ESP8266 Micropython')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> ESP8266 Micropython</a>
        </li>
        
        <div style="display:none" id="hidden_ESP8266 Micropython">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../micropython/micropython/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('ESP8266 MicropythonCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_ESP8266 MicropythonCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../micropython/basic/introduction/" id="Cài đặt công cụ cần thiết">Cài đặt công cụ cần thiết </a>
                </li>
            
            </div>
        
        </div>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../projects/list/" id="Các dự án" style="font-size:95%;font-weight:bold;">Các dự án</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../license/" id="Bản quyền" style="font-size:95%;font-weight:bold;">Bản quyền</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../contributor/" id="Đóng góp" style="font-size:95%;font-weight:bold;">Đóng góp</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Internet Of Things (IoT) với ESP8266</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
    <ul class="wy-breadcrumbs">
        <li><a href="../../..">Docs</a> &raquo;</li>
          
        <li>ESP8266 NONOS-SDK &raquo;</li>
          
        <li>Smartconfig &raquo;</li>
           
        <li>ESPTOUCH & AIRKISS</li>
        <li class="wy-breadcrumbs-aside">
             
                
            <a href="https://github.com/esp8266vn/esp8266.vn/tree/master/docs/nonos-sdk/smartconfig/esptouch.md" class="icon icon-github"> Edit on GitHub</a>
                
             
        </li>
    </ul>
    <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="tong-quan">Tổng quan<a class="headerlink" href="#tong-quan" title="Permanent link">#</a></h1>
<p>ESP Touch là protocol được dùng trong Smart Config để người dùng có thể kết nối tới các phiên bản modul ESP8266 thông qua cấu hình đơn giản trên Smartphone.
Ban đầu không thể kết nối với ESP8266, nhưng thông qua giao thức ESP-TOUCH thì Smartphone sẽ gửi gói UDP tới Access Point(AP) ở đây là ESP8266, mã hóa SSID và mật khẩu thành trường Length trong gói UDP, để ESP8266 có thể hiểu và giải mã được thông tin.</p>
<p>Cấu trúc gói tin sẽ có dạng</p>
<table>
<thead>
<tr>
<th>6</th>
<th>6</th>
<th>2</th>
<th>3</th>
<th>5</th>
<th>Variable</th>
<th>4</th>
</tr>
</thead>
<tbody>
<tr>
<td>DA</td>
<td>SA</td>
<td>Length</td>
<td>LLC</td>
<td>SNAP</td>
<td>DATA</td>
<td>FCS</td>
</tr>
</tbody>
</table>
<p>Length bao gồm SSID và thông tin key cho ESP8266</p>
<h1 id="chuong-trinh">Chương trình<a class="headerlink" href="#chuong-trinh" title="Permanent link">#</a></h1>
<p>Tổ chức file căn cứ theo bài <a href="../../basic/complex-makefile/">Makefile cho các dự án phức tạp</a>, toàn bộ cấu trúc file, <strong>Makefile, user_config.h, rf_init.c</strong> giữ nguyên, thay đổi nội dung file <code>main.c</code> và thêm một số thư mục cần thiết. </p>
<div class="admonition note">
<p class="admonition-title">Nội dung</p>
<p>Smartconfig cho ESP8266 thông qua Smartphone</p>
</div>
<h2 id="lay-du-an-ve-tu-github">Lấy dự án về từ Github<a class="headerlink" href="#lay-du-an-ve-tu-github" title="Permanent link">#</a></h2>
<pre><code class="bash">https://github.com/esp8266vn/esp8266-nonos-smart-config.git
cd sp8266-nonos-smart-config &amp;&amp; make
make flash
</code></pre>

<h2 id="so-o-file">Sơ đồ file<a class="headerlink" href="#so-o-file" title="Permanent link">#</a></h2>
<pre><code>├── assets
│   └── fota-flow.png
├── build
│   ├── driver
│   │   ├── key.o
│   │   ├── led.o
│   │   └── uart.o
│   ├── esp8266-nonos-app.a
│   ├── esp8266-nonos-app.out
│   └── user
│       ├── rfinit.o
│       ├── sc.o
│       ├── user_main.o
│       └── wps.o
├── driver
│   ├── key.c
│   ├── led.c
│   ├── Makefile
│   └── uart.c
├── firmware
│   ├── esp8266-nonos-app0x00000.bin
│   └── esp8266-nonos-app0x10000.bin
├── include
│   ├── driver
│   │   ├── key.h
│   │   ├── led.h
│   │   ├── uart.h
│   │   └── uart_register.h
│   └── user_config.h
├── ld
│   ├── eagle.rom.addr.v6.ld
│   ├── with-espboot-flash-at-0x2000-size-1M.ld
│   └── without-bootloader.ld
├── Makefile
├── README.md
├── SublimeAStyleFormatter.sublime-settings
└── user
    ├── Makefile
    ├── rfinit.c
    ├── sc.c
    ├── sc.h
    ├── user_main.c
    ├── wps.c
    └── wps.h

10 directories, 41 files

</code></pre>

<h2 id="ma-nguon">Mã nguồn<a class="headerlink" href="#ma-nguon" title="Permanent link">#</a></h2>
<p>Chương trình chính sẽ gọi phần cấu hình cho Smartconfig sau khi nút nhấn FLASH trên NodeMCU được nhấn thông qua hàm <code>sc_start</code> (nằm ở 2 file là <code>sc.c</code> và <code>sc.h</code>)</p>
<pre><code>#include &quot;osapi.h&quot;
#include &quot;user_interface.h&quot;

#include &quot;driver/key.h&quot;
#include &quot;driver/uart.h&quot;
#include &quot;driver/led.h&quot;
#include &quot;wps.h&quot;
#include &quot;sc.h&quot;

#define KEY_NUM        1

#define KEY_IO_MUX     PERIPHS_IO_MUX_MTCK_U
#define KEY_IO_NUM     0
#define KEY_IO_FUNC    FUNC_GPIO0


LOCAL struct keys_param keys;
LOCAL struct single_key_param *single_key;

LOCAL void ICACHE_FLASH_ATTR
short_press(void)
{
  INFO(&quot;[KEY] Short press, run smartconfig\r\n&quot;);
  led_blink(1, 1);
  sc_start();
}

LOCAL void ICACHE_FLASH_ATTR
long_press(void)
{
  INFO(&quot;[KEY] Long press, run wps\r\n&quot;);
  led_blink(5, 5);
}


void ICACHE_FLASH_ATTR print_info()
{
  INFO(&quot;\r\n\r\n[INFO] BOOTUP...\r\n&quot;);
  INFO(&quot;[INFO] SDK: %s\r\n&quot;, system_get_sdk_version());
  INFO(&quot;[INFO] Chip ID: %08X\r\n&quot;, system_get_chip_id());
  INFO(&quot;[INFO] Memory info:\r\n&quot;);
  system_print_meminfo();

  INFO(&quot;[INFO] -------------------------------------------\n&quot;);
  INFO(&quot;[INFO] Build time: %s\n&quot;, BUID_TIME);
  INFO(&quot;[INFO] -------------------------------------------\n&quot;);

}


void ICACHE_FLASH_ATTR app_init()
{
  // const fota_info fota_conenction = {
  //   .host = &quot;test.vidieukhien.net&quot;,
  //   .port = &quot;80&quot;,
  //   .security = 0,
  //   .device_id = &quot;device_id&quot;,
  //   .access_key = &quot;access_key&quot;,
  //   .version = &quot;version&quot;,
  //   .path = &quot;/fota.json?dev={device_id|%X}&amp;token={access_key|%s}&amp;version={version:%s}&quot;
  // };

  uart_init(BIT_RATE_115200, BIT_RATE_115200);

  print_info();

  single_key = key_init_single(KEY_IO_NUM, KEY_IO_MUX, KEY_IO_FUNC,
                                        long_press, short_press);

  keys.key_num = KEY_NUM;
  keys.single_key = &amp;single_key;

  key_init(&amp;keys);
  led_init();
  led_blink(10, 10); //1 second on, 1 second off

  wifi_set_opmode_current(STATION_MODE);

}

void ICACHE_FLASH_ATTR user_init(void)
{
  system_init_done_cb(app_init);

}

</code></pre>

<h1 id="cac-ham-cau-truc-dung-trong-smartconfig">Các hàm/ cấu trúc dùng trong SmartConfig<a class="headerlink" href="#cac-ham-cau-truc-dung-trong-smartconfig" title="Permanent link">#</a></h1>
<h2 id="ham-smartconfig_start">Hàm smartconfig_start<a class="headerlink" href="#ham-smartconfig_start" title="Permanent link">#</a></h2>
<p>Hàm dùng để cấu hình thiết bị và kết nối nó tới AP</p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<ul>
<li>Hàm chỉ được gọi trong mode Station</li>
<li>Gọi hàm <code>smartconfig_stop</code> để kết thúc quá trình SmartConfig trước khi gọi các hàm khác</li>
</ul>
</div>
<p>Định nghĩa</p>
<pre><code>bool smartconfig_start(sc_callback_t cb, uint8 log)
</code></pre>

<p>Thông số</p>
<p>Giá trị trả về</p>
<table>
<thead>
<tr>
<th>TRUE</th>
<th>Thành công</th>
</tr>
</thead>
<tbody>
<tr>
<td>FALSE</td>
<td>Thất bại</td>
</tr>
</tbody>
</table>
<h2 id="ham-smartconfig_stop">Hàm smartconfig_stop<a class="headerlink" href="#ham-smartconfig_stop" title="Permanent link">#</a></h2>
<p>Hàm dùng để dừng quá trình Smart Config và giải phóng bộ nhớ được tạo ra bởi hàm  <code>smartconfig_start</code></p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Sau khi kết nối được thiết lập thì người dùng có thể gọi hàm giải phóng bộ nhớ</p>
</div>
<p>Định nghĩa</p>
<pre><code>bool smartconfig_set_type(sc_type type)
</code></pre>

<p>Thông số </p>
<pre><code>typedef enum {
 SC_TYPE_ESPTOUCH = 0,
 SC_TYPE_AIRKISS,
 SC_TYPE_ESPTOUCH_AIRKISS,
 } sc_type; 
</code></pre>

<p>Giá trị trả về</p>
<table>
<thead>
<tr>
<th>TRUE</th>
<th>Thành công</th>
</tr>
</thead>
<tbody>
<tr>
<td>FALSE</td>
<td>Thất bại</td>
</tr>
</tbody>
</table>
<h2 id="ham-smartconfig_set_type">Hàm smartconfig_set_type<a class="headerlink" href="#ham-smartconfig_set_type" title="Permanent link">#</a></h2>
<p>Hàm dùng để thiết lập kiểu protocol của <code>smartconfig_start</code></p>
<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>Phải gọi hàm này trước hàm <code>smartconfig_start</code></p>
</div>
<p>Định nghĩa</p>
<pre><code>bool smartconfig_stop(void)
</code></pre>

<p>Thông số 
NULL</p>
<p>Giá trị trả về</p>
<table>
<thead>
<tr>
<th>TRUE</th>
<th>Thành công</th>
</tr>
</thead>
<tbody>
<tr>
<td>FALSE</td>
<td>Thất bại</td>
</tr>
</tbody>
</table>
<h2 id="cau-truc">Cấu trúc<a class="headerlink" href="#cau-truc" title="Permanent link">#</a></h2>
<p>Có 2 kiểu cấu trúc cho sc_status và sc_type</p>
<pre><code>typedef enum {
SC_STATUS_WAIT = 0,
SC_STATUS_FIND_CHANNEL = 0,
SC_STATUS_GETTING_SSID_PSWD,
SC_STATUS_LINK,
SC_STATUS_LINK_OVER,
} sc_status; 
</code></pre>

<pre><code>typedef enum {
SC_TYPE_ESPTOUCH = 0,
SC_TYPE_AIRKISS,
SC_TYPE_ESPTOUCH_AIRKISS,
} sc_type;
</code></pre>

<div class="admonition note">
<p class="admonition-title">Lưu ý</p>
<p>SC_STATUS_FIND_CHANNEL được dùng để hiển thị trạng thái khi tìm channel</p>
</div>
<h1 id="phan-mem-cho-android-va-ios">Phần mềm cho android và iOS<a class="headerlink" href="#phan-mem-cho-android-va-ios" title="Permanent link">#</a></h1>
<p>Có thể tải file apk dành cho android tại 
<a href="https://espressif.com/sites/default/files/apks/esptouchandroid-apk_v0.3.4.3_0.rar">ESP-Touch Android</a></p>
<p>Hoặc tải trực tiếp từ Playstore
<a href="https://play.google.com/store/apps/details?id=com.cmmakerclub.iot.esptouch&amp;hl=vi">ESP8266 SmartConfig</a></p>
<p>Và file cho iOS
<a href="https://espressif.com/sites/default/files/apks/esptouchios-ipa_v0.3.4.3_0.rar">ESP-Touch iOS</a></p>
<h1 id="hoat-ong">Hoạt động<a class="headerlink" href="#hoat-ong" title="Permanent link">#</a></h1>
<ul>
<li>Kích hoạt chức năng Smart Config bằng cách lập trình và nạp firmware cho ESP</li>
<li>Kết nối smartphone với router (kết nối smartphone với mạng wifi hiện có)</li>
<li>Mở ESP-TOUCH App đã cài đặt trên smartphone</li>
<li>Kiểm tra SSID (tương ứng với tên Wifi) và mật khẩu (ở đây là mật khẩu wifi của bạn) để kết nối tới thiết bị.</li>
<li>Thực hiện ấn nút trong thời gian ngắn trên NodeMCU sau đó thả ra sẽ có thông báo</li>
</ul>
<pre><code>[INFO] BOOTUP...
[INFO] SDK: 2.0.0(656edbf)
[INFO] Chip ID: 000A8B7A
[INFO] Memory info:
data  : 0x3ffe8000 ~ 0x3ffe880c, len: 2060
rodata: 0x3ffe8810 ~ 0x3ffe9ff0, len: 6112
bss   : 0x3ffe9ff0 ~ 0x3fff0858, len: 26728
heap  : 0x3fff0858 ~ 0x3fffc000, len: 47016
[INFO] -------------------------------------------
[INFO] Build time: 2016-Th11-18_16:55:45_ICT
[INFO] -------------------------------------------
bcn 0
del if1
usl
mode : sta(60:01:94:0a:8b:7a)
add if0
</code></pre>

<ul>
<li>Mở phần mềm IOT_Espressift_EspTouch trên điện thoại đã kết nối wifi, nhập mật khẩu tại Password sau đó ấn confirm</li>
</ul>
<p><img alt="IOT_Espressift_EspTouch" src="../../images/esp-touch.png" /></p>
<ul>
<li>Tiếp tục ấn nút Flash trên NodeMCU sau đó ấn nút Confirm trên SmartPhone.</li>
</ul>
<p><img alt="IOT_Espressift_EspTouch" src="../../images/esp-touch-done.png" /></p>
<h1 id="ket-qua">Kết quả<a class="headerlink" href="#ket-qua" title="Permanent link">#</a></h1>
<ul>
<li>Nếu thành công sẽ có thông báo trên smartphone về địa chỉ IP của ESP8266 như sau</li>
</ul>
<pre><code>Esptouch success, bssid = xxxx, InnetAddress = 192.168.xx.xx
</code></pre>

<ul>
<li>Ngược lại sẽ có thông báo Esptouch fail.</li>
<li>Kết quả logfile sẽ được ghi lại trên máy tính như sau</li>
</ul>
<pre><code>[INFO] BOOTUP...
[INFO] SDK: 2.0.0(656edbf)
[INFO] Chip ID: 000A8B7A
[INFO] Memory info:
data  : 0x3ffe8000 ~ 0x3ffe880c, len: 2060
rodata: 0x3ffe8810 ~ 0x3ffe9ff0, len: 6112
bss   : 0x3ffe9ff0 ~ 0x3fff0858, len: 26728
heap  : 0x3fff0858 ~ 0x3fffc000, len: 47016
[INFO] -------------------------------------------
[INFO] Build time: 2016-Th11-18_16:55:45_ICT
[INFO] -------------------------------------------
bcn 0
del if1
usl
mode : sta(60:01:94:0a:8b:7a)
add if0
[KEY] Short press, run smartconfig
SC version: V2.5.4
[SC] Started
scandone
scandone
[SC] SC_STATUS_FIND_CHANNEL
00:16:01:04:6d:d2: 599
00:16:01:04:6d:d2: 598
00:16:01:04:6d:d2: 597
00:16:01:04:6d:d2: 596
T|once 1 84
00:16:01:04:6d:d2: 599
00:16:01:04:6d:d2: 598
00:16:01:04:6d:d2: 597
00:16:01:04:6d:d2: 596
T|once 2 84
iBssid 00:16:01:04:6d:
buf 00:16:01:04:6d:
save, rssi:-81 00:16:01:04:6d:d2:
iCh lock
00:16:01:04:6d:d2: 598
00:16:01:04:6d:d2: 597
rigtt,rssi:-81 00:16:01:04:6d:d2:

TYPE: ESPTOUCH
T|sniffer on ch:2
T|AP MAC: 00 16 01 04 6d d2
T|Head Len : 84
[SC] SC_STATUS_GETTING_SSID_PSWD
[SC] SC_TYPE:SC_TYPE_ESPTOUCH
T|SYNC STATUS
xxxxx
T|pswd: mat_khau_wifi
T|ssid: ten_wifi
T|bssid: 00 16 01 04 6d d2 
[SC] SC_STATUS_LINK
scandone
xxxxx
connected with ten_wifi, channel 2
dhcp client start...
pm open,type:2 0
ip:192.168.1.xx,mask:255.255.255.0,gw:192.168.1.1
[SC] SC_STATUS_LINK_OVER
[SC] Phone ip: 192.168.1.xx
free heap:39984

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../wps/" class="btn btn-neutral float-right" title="WPS">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../why-smartconfig/" class="btn btn-neutral" title="Tại sao cần Smartconfig"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://esp8266.vn">ESP8266 Viet Nam</a> - Tài trợ bởi <a href="https://iotmaker.vn">IoT Maker Viet Nam</a></p>
    
  </div>

  
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<!-- <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/esp8266vn/esp8266.vn" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../why-smartconfig/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../wps/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div> -->

<script type="text/javascript">
  // If cookie is defined toggle the id
  if (typeof $.cookie('docToggle') !== 'undefined') {
      // Parse cookie which is an array
      var _parsed_cookie = JSON.parse($.cookie('docToggle'));
      // Loop over array and show hidden divs
      $.each(_parsed_cookie, function(index, value) {
          // Toggle
          $("[id='hidden_" + value + "']").css('display','');
      })
  }
</script>

</body>
</html>